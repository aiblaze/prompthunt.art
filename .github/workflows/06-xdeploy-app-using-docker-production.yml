# ============================================================================
# XDeploy åº”ç”¨å®¹å™¨åŒ–éƒ¨ç½²å·¥ä½œæµ
# ============================================================================
#
# åŠŸèƒ½è¯´æ˜ï¼š
#   - ä½¿ç”¨ Docker å®¹å™¨éƒ¨ç½²åº”ç”¨åˆ°æœåŠ¡å™¨
#   - åŸºäº Docker Compose è¿›è¡Œå®¹å™¨ç¼–æ’
#   - è‡ªåŠ¨æ‹‰å–æœ€æ–°é•œåƒå¹¶é‡å¯æœåŠ¡
#   - éƒ¨ç½²åå¥åº·æ£€æŸ¥éªŒè¯
#
# ä½¿ç”¨åœºæ™¯ï¼š
#   - Docker é•œåƒæ„å»ºå®Œæˆåè‡ªåŠ¨éƒ¨ç½²
#   - æ‰‹åŠ¨æŒ‡å®šé•œåƒæ ‡ç­¾è¿›è¡Œéƒ¨ç½²
#   - ç”Ÿäº§ç¯å¢ƒå®¹å™¨åŒ–åº”ç”¨éƒ¨ç½²
#
# è§¦å‘æ–¹å¼ï¼š
#   - è‡ªåŠ¨è§¦å‘ï¼š05-XDeploy-Docker-Image å·¥ä½œæµæˆåŠŸå®Œæˆå
#   - æ‰‹åŠ¨è§¦å‘ï¼šå¯æŒ‡å®šç‰¹å®šçš„é•œåƒæ ‡ç­¾
#
# å‰ç½®æ¡ä»¶ï¼š
#   - Docker é•œåƒå·²æ„å»ºå¹¶æ¨é€åˆ°ä»“åº“
#   - æœåŠ¡å™¨å·²å®‰è£… Docker å’Œ Docker Compose
#   - SSH å¯†é’¥å·²é…ç½®
#   - å®¹å™¨é•œåƒä»“åº“å‡­æ®å·²é…ç½®
#
# éƒ¨ç½²æµç¨‹ï¼š
#   1. ç”Ÿæˆ Docker Compose é…ç½®æ–‡ä»¶
#   2. ç™»å½•å®¹å™¨é•œåƒä»“åº“
#   3. æ‹‰å–æœ€æ–°é•œåƒ
#   4. åœæ­¢æ—§å®¹å™¨
#   5. å¯åŠ¨æ–°å®¹å™¨
#   6. å¥åº·æ£€æŸ¥éªŒè¯
#
# å®¹å™¨ç®¡ç†åŠŸèƒ½ï¼š
#   - é›¶åœæœºéƒ¨ç½²
#   - å®¹å™¨å¥åº·æ£€æŸ¥
#   - æ—¥å¿—ç®¡ç†
#   - èµ„æºé™åˆ¶é…ç½®
#   - ç½‘ç»œé…ç½®
#
# ç›‘æ§ä¸ç»´æŠ¤ï¼š
#   - éƒ¨ç½²çŠ¶æ€ç›‘æ§
#   - å®¹å™¨è¿è¡ŒçŠ¶æ€æ£€æŸ¥
#   - éƒ¨ç½²æ‘˜è¦æŠ¥å‘Š
#
# ============================================================================

name: 06-XDeployAppUsingDocker-production

on:
  workflow_run:
    workflows: [05-XDeployDockerImage-production]
    types:
      - completed
    branches:
      - release
  workflow_dispatch:
    inputs:
      tag:
        description: 'é•œåƒæ ‡ç­¾ (é»˜è®¤: latest)'
        required: false
        default: latest
        type: string

env:
  WORKFLOW_SCRIPTS_DIR: ${{ github.workspace }}/.xdeploy/production/scripts/workflows
  WORKFLOW_UTILS_DIR: ${{ github.workspace }}/.xdeploy/production/scripts/workflows/utils
  DEPLOY_SCRIPTS_DIR: ${{ github.workspace }}/.xdeploy/production/scripts/server
  DEPLOY_CONFIGS_DIR: ${{ github.workspace }}/.xdeploy/production/configs
  APP_DEPLOY_DIR_SERVER: /xdeploy/apps/prompthunt/production

jobs:
  deploy:
    environment: production
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set deployment environment
        id: set-env
        run: |
          ENV="${{ vars.XDP_DEPLOY_ENV || 'production' }}"
          echo "DEPLOY_ENV=$ENV" >> "$GITHUB_OUTPUT"
          echo "ä½¿ç”¨éƒ¨ç½²ç¯å¢ƒ: $ENV"

      - name: Set deployment tag
        id: set-tag
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "TAG=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
          elif [ -n "${{ vars.XDP_APP_IMAGE_TAG }}" ]; then
            echo "TAG=${{ vars.XDP_APP_IMAGE_TAG }}" >> "$GITHUB_OUTPUT"
          else
            echo "TAG=latest" >> "$GITHUB_OUTPUT"
          fi

      - name: Set deployment servers
        id: set-servers
        run: |
          if [ -n "${{ vars.XDP_SERVERS }}" ]; then
            echo "ä½¿ç”¨ä»“åº“å˜é‡ä¸­çš„ XDP_SERVERS"
            echo "SERVERS=${{ vars.XDP_SERVERS }}" >> "$GITHUB_OUTPUT"
          else
            echo "é”™è¯¯ï¼šæœªæä¾›æœåŠ¡å™¨åˆ—è¡¨ã€‚è¯·åœ¨å·¥ä½œæµè¾“å…¥ä¸­æŒ‡å®šæœåŠ¡å™¨æˆ–åœ¨ä»“åº“å˜é‡ä¸­è®¾ç½® XDP_SERVERSã€‚"
            exit 1
          fi

      - name: Setup script environment
        run: |
          # ç¡®ä¿æ‰€æœ‰è„šæœ¬æœ‰æ‰§è¡Œæƒé™
          chmod +x ${WORKFLOW_SCRIPTS_DIR}/*.sh
          chmod +x ${WORKFLOW_UTILS_DIR}/*.sh
          chmod +x ${DEPLOY_SCRIPTS_DIR}/*.sh

      - name: Generate docker-compose.yml
        run: |
          mkdir -p ./deploy
          # ä½¿ç”¨ç¯å¢ƒç‰¹å®šçš„ docker-compose æ¨¡æ¿
          cp "${{ env.DEPLOY_CONFIGS_DIR }}/docker-compose.yml" ./deploy/docker-compose.yml

          echo "ç”Ÿæˆçš„ docker-compose.yml æ–‡ä»¶ï¼š"
          cat ./deploy/docker-compose.yml

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.XDS_SSH_PRIVATE_KEY }}
          known_hosts: placeholder # å°†åœ¨ä¸‹ä¸€æ­¥ä¸­å¡«å……
          if_key_exists: replace

      - name: Deploy to servers
        id: deploy
        run: |
          # åˆ†å‰²æœåŠ¡å™¨åˆ—è¡¨
          IFS=',' read -ra SERVER_ARRAY <<< "${{ steps.set-servers.outputs.SERVERS }}"

          # éƒ¨ç½²åˆ°æ¯ä¸ªæœåŠ¡å™¨
          for server in "${SERVER_ARRAY[@]}"; do
            echo "===== å¼€å§‹éƒ¨ç½²åˆ°æœåŠ¡å™¨: $server ====="

            # æ·»åŠ æœåŠ¡å™¨åˆ°å·²çŸ¥ä¸»æœº
            ssh-keyscan -H $(echo $server | cut -d@ -f2) >> ~/.ssh/known_hosts

            # ä½¿ç”¨éƒ¨ç½²è„šæœ¬
            ./.xdeploy/${{ steps.set-env.outputs.DEPLOY_ENV }}/scripts/workflows/app-deploy.sh \
              "$server" \
              "${{ vars.XDP_APP_NAME }}" \
              "$APP_DEPLOY_DIR_SERVER" \
              "${{ vars.XDP_APP_PORT }}" \
              "${{ vars.XDP_APP_PORT_CONTAINER || vars.XDP_APP_PORT }}" \
              "${{ vars.XDP_APP_IMAGE_NAME || vars.XDP_APP_NAME }}" \
              "${{ steps.set-tag.outputs.TAG }}" \
              "${{ vars.XDP_REGISTRY_URL }}" \
              "${{ vars.XDP_REGISTRY_NAMESPACE }}" \
              "${{ vars.XDP_REGISTRY_USERNAME }}" \
              "${{ secrets.XDS_REGISTRY_PASSWORD }}" \
              "./deploy/docker-compose.yml"

            echo "===== æœåŠ¡å™¨ $server éƒ¨ç½²å®Œæˆ ====="
          done

      - name: Health check
        run: |
          # åˆ†å‰²æœåŠ¡å™¨åˆ—è¡¨
          IFS=',' read -ra SERVER_ARRAY <<< "${{ steps.set-servers.outputs.SERVERS }}"

          # æ£€æŸ¥æ¯ä¸ªæœåŠ¡å™¨ä¸Šçš„åº”ç”¨
          for server in "${SERVER_ARRAY[@]}"; do
            echo "æ£€æŸ¥æœåŠ¡å™¨ $server ä¸Šçš„åº”ç”¨å¥åº·çŠ¶æ€..."
            ${WORKFLOW_SCRIPTS_DIR}/app-deploy.sh \
              "$server" \
              "${{ vars.XDP_APP_NAME }}" \
              "$APP_DEPLOY_DIR_SERVER" \
              "${{ vars.XDP_APP_PORT }}" \
              "${{ vars.XDP_APP_PORT_CONTAINER || vars.XDP_APP_PORT }}" \
              "${{ vars.XDP_APP_IMAGE_NAME || vars.XDP_APP_NAME }}" \
              "${{ steps.set-tag.outputs.TAG }}" \
              "${{ vars.XDP_REGISTRY_URL }}" \
              "${{ vars.XDP_REGISTRY_NAMESPACE }}" \
              "${{ vars.XDP_REGISTRY_USERNAME }}" \
              "${{ secrets.XDS_REGISTRY_PASSWORD }}" \
              "./deploy/docker-compose.yml" \
              "true"
          done

      - name: Deployment Summary
        run: |
          echo "âœ… éƒ¨ç½²æµç¨‹å®Œæˆï¼"
          echo "ğŸ“‹ éƒ¨ç½²è¯¦æƒ…ï¼š"
          echo "   - éƒ¨ç½²ç¯å¢ƒï¼š${{ steps.set-env.outputs.DEPLOY_ENV }}"
          echo "   - éƒ¨ç½²æœåŠ¡å™¨ï¼š${{ steps.set-servers.outputs.SERVERS }}"
          echo "   - åº”ç”¨åç§°ï¼š${{ vars.XDP_APP_NAME }}"
          echo "   - åº”ç”¨ Docker Compose æ–‡ä»¶ç›®å½•ï¼š$APP_DEPLOY_DIR_SERVER"
          echo "   - åº”ç”¨å¤–éƒ¨ç«¯å£ï¼š${{ vars.XDP_APP_PORT }}"
          echo "   - åº”ç”¨å®¹å™¨å†…éƒ¨ç«¯å£ï¼š${{ vars.XDP_APP_PORT_CONTAINER }}"
          echo "   - é•œåƒåç§°ï¼š${{ vars.XDP_APP_IMAGE_NAME || vars.XDP_APP_NAME }}"
          echo "   - é•œåƒæ ‡ç­¾ï¼š${{ steps.set-tag.outputs.TAG }}"
          echo "   - éƒ¨ç½²æ—¶é—´ï¼š$(date)"
          echo "   - åº”ç”¨è®¿é—®åœ°å€ï¼šhttps://${{ vars.XDP_APP_DOMAIN || vars.XDP_APP_NAME }}"
