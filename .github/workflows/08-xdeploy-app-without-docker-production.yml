# ============================================================================
# XDeploy åº”ç”¨ç›´æ¥éƒ¨ç½²å·¥ä½œæµï¼ˆéå®¹å™¨åŒ–ï¼‰
# ============================================================================
#
# åŠŸèƒ½è¯´æ˜ï¼š
#   - ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šæ„å»ºå’Œéƒ¨ç½²åº”ç”¨ï¼ˆä¸ä½¿ç”¨ Dockerï¼‰
#   - æ”¯æŒä½¿ç”¨ semantic-release è¿›è¡Œç‰ˆæœ¬ç®¡ç†
#   - æ”¯æŒå¤šç§ Node.js åŒ…ç®¡ç†å™¨ï¼ˆnpmã€yarnã€pnpmã€bunï¼‰
#   - ä½¿ç”¨ PM2 è¿›è¡Œè¿›ç¨‹ç®¡ç†
#   - çµæ´»çš„æ„å»ºå’Œéƒ¨ç½²é…ç½®é€‰é¡¹
#
# ä½¿ç”¨åœºæ™¯ï¼š
#   - ä¸é€‚åˆå®¹å™¨åŒ–çš„åº”ç”¨éƒ¨ç½²
#   - éœ€è¦ç›´æ¥è®¿é—®æœåŠ¡å™¨èµ„æºçš„åº”ç”¨
#   - è½»é‡çº§åº”ç”¨çš„å¿«é€Ÿéƒ¨ç½²
#   - å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒçš„åº”ç”¨éƒ¨ç½²
#
# æ”¯æŒçš„åŒ…ç®¡ç†å™¨ï¼š
#   - npmï¼šNode.js é»˜è®¤åŒ…ç®¡ç†å™¨
#   - yarnï¼šFacebook å¼€å‘çš„åŒ…ç®¡ç†å™¨
#   - pnpmï¼šé«˜æ•ˆçš„ç£ç›˜ç©ºé—´åˆ©ç”¨
#   - bunï¼šé«˜æ€§èƒ½çš„ JavaScript è¿è¡Œæ—¶
#
# éƒ¨ç½²é€‰é¡¹ï¼š
#   - Node.js ç‰ˆæœ¬é€‰æ‹©
#   - è‡ªå®šä¹‰æ„å»ºå‘½ä»¤
#   - éƒ¨ç½²å‰ç›®å½•æ¸…ç†
#   - éƒ¨ç½²åä¾èµ–å®‰è£…
#   - PM2 è¿›ç¨‹ç®¡ç†é…ç½®
#
# å‰ç½®æ¡ä»¶ï¼š
#   - æœåŠ¡å™¨å·²å®‰è£… Node.js å’Œ PM2
#   - SSH å¯†é’¥å·²é…ç½®
#   - åº”ç”¨åŒ…å«æœ‰æ•ˆçš„ package.json
#
# éƒ¨ç½²æµç¨‹ï¼š
#   1. æ£€å‡ºä»£ç å¹¶è®¾ç½® Node.js ç¯å¢ƒ
#   2. å®‰è£…é¡¹ç›®ä¾èµ–
#   3. æ„å»ºåº”ç”¨ï¼ˆå¯è‡ªå®šä¹‰æ„å»ºå‘½ä»¤ï¼‰
#   4. éƒ¨ç½²æ„å»ºäº§ç‰©åˆ°æœåŠ¡å™¨
#   5. é…ç½® PM2 è¿›ç¨‹ç®¡ç†
#   6. å¯åŠ¨æˆ–é‡å¯åº”ç”¨æœåŠ¡
#
# è¿›ç¨‹ç®¡ç†ï¼š
#   - PM2 ç”Ÿæ€ç³»ç»Ÿé…ç½®
#   - è¿›ç¨‹ç›‘æ§å’Œè‡ªåŠ¨é‡å¯
#   - æ—¥å¿—ç®¡ç†
#   - è´Ÿè½½å‡è¡¡é…ç½®
#
# ============================================================================

name: 08-XDeployAppWithoutDocker-production

on:
  push:
    branches:
      - release
  workflow_dispatch:
    inputs:
      node_version:
        description: Node.js ç‰ˆæœ¬
        required: false
        type: string
        default: latest
      bun_version:
        description: Bun ç‰ˆæœ¬
        required: false
        type: string
        default: latest
      build_command:
        description: æ„å»ºå‘½ä»¤
        required: false
        type: string
        default: pnpm run build
      package_manager:
        description: 'åŒ…ç®¡ç†å™¨ (npm, yarn, pnpm, bun)'
        required: false
        type: string
        default: pnpm
      clean_before_deploy:
        description: éƒ¨ç½²å‰æ¸…ç†ç›®æ ‡ç›®å½•
        required: false
        type: boolean
        default: true
      run_install_after_deploy:
        description: éƒ¨ç½²åæ˜¯å¦è¿è¡Œä¾èµ–å®‰è£…
        required: false
        type: boolean
        default: false

permissions: write-all

env:
  WORKFLOW_SCRIPTS_DIR: ${{ github.workspace }}/.xdeploy/production/scripts/workflows
  WORKFLOW_UTILS_DIR: ${{ github.workspace }}/.xdeploy/production/scripts/workflows/utils
  DEPLOY_SCRIPTS_DIR: ${{ github.workspace }}/.xdeploy/production/scripts/server
  DEPLOY_CONFIGS_DIR: ${{ github.workspace }}/.xdeploy/production/configs
  APP_DEPLOY_DIR_SERVER: /xdeploy/apps/prompthunt/production

jobs:
  semantic-release:
    environment: production
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install

      - name: Run semantic-release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npx semantic-release
          echo "new_release_published=true" >> "$GITHUB_OUTPUT"
          echo "new_release_version=$(node -p "require('./package.json').version")" >> "$GITHUB_OUTPUT"

  build-and-deploy:
    environment: production
    runs-on: ubuntu-latest
    needs: [semantic-release]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set deployment environment
        id: set-env
        run: |
          ENV="${{ vars.XDP_DEPLOY_ENV || 'production' }}"
          echo "DEPLOY_ENV=$ENV" >> "$GITHUB_OUTPUT"
          echo "ä½¿ç”¨éƒ¨ç½²ç¯å¢ƒ: $ENV"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ github.event.inputs.node_version || vars.XDP_NODE_VERSION || '24' }}

      - name: Setup PNPM
        if: ${{ github.event.inputs.package_manager == 'pnpm' || (github.event.inputs.package_manager == '' && !contains(fromJSON('["npm", "yarn", "bun"]'), github.event.inputs.package_manager)) }}
        uses: pnpm/action-setup@v4

      - name: Setup BUN
        if: ${{ github.event.inputs.package_manager == 'bun' }}
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ github.event.inputs.bun_version || 'latest' }}

      - name: Install dependencies
        run: |
          PACKAGE_MANAGER="${{ github.event.inputs.package_manager || 'pnpm' }}"
          case "$PACKAGE_MANAGER" in
            npm)
              npm ci
              ;;
            yarn)
              yarn install --frozen-lockfile
              ;;
            pnpm)
              pnpm install --frozen-lockfile
              ;;
            bun)
              bun install
              ;;
            *)
              echo "ä½¿ç”¨é»˜è®¤åŒ…ç®¡ç†å™¨ pnpm"
              pnpm install --frozen-lockfile
              ;;
          esac

      - name: Set build parameters
        id: build-params
        run: |
          # è®¾ç½®æ„å»ºè¾“å‡ºç›®å½•
          if [ -n "${{ vars.XDP_APP_BUILD_DIR }}" ]; then
            BUILD_DIR="${{ vars.XDP_APP_BUILD_DIR }}"
          else
            BUILD_DIR="dist"
          fi
          echo "BUILD_DIR=$BUILD_DIR" >> "$GITHUB_OUTPUT"
          echo "æ„å»ºè¾“å‡ºç›®å½•: $BUILD_DIR"

          # è®¾ç½®åŒ…ç®¡ç†å™¨
          PACKAGE_MANAGER="${{ github.event.inputs.package_manager || 'pnpm' }}"
          echo "PACKAGE_MANAGER=$PACKAGE_MANAGER" >> "$GITHUB_OUTPUT"

          # è®¾ç½® PM2 ä¸»é…ç½®ç›®å½•
          PM2_CONFIG_DIR="${{ vars.XDP_PM2_CONFIG_DIR || '/xdeploy/pm2' }}"
          echo "PM2_CONFIG_DIR=$PM2_CONFIG_DIR" >> "$GITHUB_OUTPUT"
          echo "PM2 ä¸»é…ç½®ç›®å½•: $PM2_CONFIG_DIR"

          # è®¾ç½® PM2 ä¸»é…ç½®æ–‡ä»¶
          PM2_CONFIG_FILE="$PM2_CONFIG_DIR/ecosystem.config.js"
          echo "PM2_CONFIG_FILE=$PM2_CONFIG_FILE" >> "$GITHUB_OUTPUT"
          echo "PM2 ä¸»é…ç½®æ–‡ä»¶: $PM2_CONFIG_FILE"

      - name: Set deployment servers
        id: set-servers
        run: |
          if [ -n "${{ vars.XDP_SERVERS }}" ]; then
            echo "ä½¿ç”¨ä»“åº“å˜é‡ä¸­çš„ XDP_SERVERS"
            echo "SERVERS=${{ vars.XDP_SERVERS }}" >> "$GITHUB_OUTPUT"
          else
            echo "é”™è¯¯ï¼šæœªæä¾›æœåŠ¡å™¨åˆ—è¡¨ã€‚è¯·åœ¨ä»“åº“å˜é‡ä¸­è®¾ç½® XDP_SERVERSã€‚"
            exit 1
          fi

      - name: Setup build environment variables
        id: build-env
        run: |
          ENV_BUILD_TEMPLATE="${{ env.DEPLOY_CONFIGS_DIR }}/env.build"
          if [ -f "$ENV_BUILD_TEMPLATE" ]; then
            echo "ä½¿ç”¨æ„å»ºç¯å¢ƒå˜é‡æ¨¡æ¿..."
            cp "$ENV_BUILD_TEMPLATE" .env.${{ steps.set-env.outputs.DEPLOY_ENV }}

            echo "é…ç½®äº†æ„å»ºç¯å¢ƒå˜é‡:"
            cat .env.${{ steps.set-env.outputs.DEPLOY_ENV }} | grep -v "^#" | grep -v "^$"
          else
            echo "æœªæ‰¾åˆ°æ„å»ºç¯å¢ƒå˜é‡æ¨¡æ¿ï¼Œè·³è¿‡..."
          fi

      - name: Build app
        run: |
          # åŠ è½½æ„å»ºç¯å¢ƒå˜é‡
          ENV_FILE=".env.${{ steps.set-env.outputs.DEPLOY_ENV }}"
          if [ -f "$ENV_FILE" ]; then
            echo "åŠ è½½æ„å»ºç¯å¢ƒå˜é‡æ–‡ä»¶: $ENV_FILE"
            set -a  # è‡ªåŠ¨å¯¼å‡ºå˜é‡
            source "$ENV_FILE"
            set +a  # åœæ­¢è‡ªåŠ¨å¯¼å‡º
          else
            echo "æœªæ‰¾åˆ°æ„å»ºç¯å¢ƒå˜é‡æ–‡ä»¶: $ENV_FILE"
            echo "ä½¿ç”¨é»˜è®¤ NODE_OPTIONS"
            export NODE_OPTIONS="--max-old-space-size=4096"
          fi

          ${{ github.event.inputs.build_command || 'pnpm run build' }}

      - name: Prepare deployment scripts
        run: |
          # ç¡®ä¿æ‰€æœ‰è„šæœ¬æœ‰æ‰§è¡Œæƒé™
          chmod +x ${WORKFLOW_SCRIPTS_DIR}/*.sh
          chmod +x ${WORKFLOW_UTILS_DIR}/*.sh
          chmod +x ${DEPLOY_SCRIPTS_DIR}/*.sh

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.XDS_SSH_PRIVATE_KEY }}
          known_hosts: placeholder # å°†åœ¨ä¸‹ä¸€æ­¥ä¸­å¡«å……
          if_key_exists: replace

      - name: Deploy to servers
        id: deploy
        run: |
          # åˆ†å‰²æœåŠ¡å™¨åˆ—è¡¨
          IFS=',' read -ra SERVER_ARRAY <<< "${{ steps.set-servers.outputs.SERVERS }}"

          # éƒ¨ç½²åˆ°æ¯ä¸ªæœåŠ¡å™¨
          for server in "${SERVER_ARRAY[@]}"; do
            echo "===== å¼€å§‹éƒ¨ç½²åˆ°æœåŠ¡å™¨: $server ====="

            # æ·»åŠ æœåŠ¡å™¨åˆ°å·²çŸ¥ä¸»æœº
            ssh-keyscan -H $(echo $server | cut -d@ -f2) >> ~/.ssh/known_hosts

            # ä½¿ç”¨ Bash è„šæœ¬éƒ¨ç½²åº”ç”¨
            bash ${WORKFLOW_SCRIPTS_DIR}/app-direct-deploy.sh \
              "$server" \
              "${{ vars.XDP_APP_NAME }}" \
              "$APP_DEPLOY_DIR_SERVER" \
              "${{ steps.set-env.outputs.DEPLOY_ENV }}" \
              "${{ vars.XDP_APP_PORT }}" \
              "${{ steps.build-params.outputs.BUILD_DIR }}" \
              "${{ github.event.inputs.clean_before_deploy }}" \
              "${{ github.event.inputs.run_install_after_deploy }}" \
              "${{ steps.build-params.outputs.PACKAGE_MANAGER }}" \
              "${{ steps.build-params.outputs.PM2_CONFIG_FILE }}"

            echo "===== æœåŠ¡å™¨ $server éƒ¨ç½²å®Œæˆ ====="
          done

      - name: Deployment Summary
        run: |
          echo "## åº”ç”¨ç›´æ¥éƒ¨ç½²æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "âœ… éƒ¨ç½²æµç¨‹å®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“‹ éƒ¨ç½²è¯¦æƒ…ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- éƒ¨ç½²ç¯å¢ƒï¼š${{ steps.set-env.outputs.DEPLOY_ENV }}" >> $GITHUB_STEP_SUMMARY
          echo "- éƒ¨ç½²æœåŠ¡å™¨ï¼š${{ steps.set-servers.outputs.SERVERS }}" >> $GITHUB_STEP_SUMMARY
          echo "- åº”ç”¨åç§°ï¼š${{ vars.XDP_APP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- åº”ç”¨éƒ¨ç½²ç›®å½•ï¼š$APP_DEPLOY_DIR_SERVER" >> $GITHUB_STEP_SUMMARY
          echo "- åº”ç”¨ç«¯å£ï¼š${{ vars.XDP_APP_PORT }}" >> $GITHUB_STEP_SUMMARY
          echo "- æ„å»ºè¾“å‡ºç›®å½•ï¼š${{ steps.build-params.outputs.BUILD_DIR }}" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js ç‰ˆæœ¬ï¼š${{ github.event.inputs.node_version || vars.XDP_NODE_VERSION || '18' }}" >> $GITHUB_STEP_SUMMARY
          echo "- åŒ…ç®¡ç†å™¨ï¼š${{ steps.build-params.outputs.PACKAGE_MANAGER }}" >> $GITHUB_STEP_SUMMARY
          echo "- æ„å»ºå‘½ä»¤ï¼š${{ github.event.inputs.build_command || 'pnpm run build' }}" >> $GITHUB_STEP_SUMMARY
          echo "- PM2 é…ç½®ç›®å½•ï¼š${{ steps.build-params.outputs.PM2_CONFIG_DIR }}" >> $GITHUB_STEP_SUMMARY
          echo "- éƒ¨ç½²å‰æ¸…ç†ç›®æ ‡ç›®å½•ï¼š${{ github.event.inputs.clean_before_deploy }}" >> $GITHUB_STEP_SUMMARY
          echo "- éƒ¨ç½²åè¿è¡Œä¾èµ–å®‰è£…ï¼š${{ github.event.inputs.run_install_after_deploy }}" >> $GITHUB_STEP_SUMMARY
          echo "- éƒ¨ç½²æ—¶é—´ï¼š$(date)" >> $GITHUB_STEP_SUMMARY
          echo "- åº”ç”¨è®¿é—®åœ°å€ï¼šhttp://${{ vars.XDP_APP_DOMAIN || vars.XDP_APP_NAME }}:${{ vars.XDP_APP_PORT }}" >> $GITHUB_STEP_SUMMARY
