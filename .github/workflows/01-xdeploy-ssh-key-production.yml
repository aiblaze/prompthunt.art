# ============================================================================
# XDeploy SSH å¯†é’¥ç”Ÿæˆä¸éƒ¨ç½²å·¥ä½œæµ
# ============================================================================
#
# åŠŸèƒ½è¯´æ˜ï¼š
#   - è‡ªåŠ¨ç”Ÿæˆ SSH å¯†é’¥å¯¹ç”¨äº GitHub Actions ä¸æœåŠ¡å™¨çš„å®‰å…¨è¿æ¥
#   - å°†å…¬é’¥éƒ¨ç½²åˆ°æŒ‡å®šçš„æœåŠ¡å™¨ä¸Šï¼Œå®ç°å…å¯†ç ç™»å½•
#   - æµ‹è¯• SSH è¿æ¥ç¡®ä¿å¯†é’¥é…ç½®æ­£ç¡®
#   - è¾“å‡ºç§é’¥ä¾›ç”¨æˆ·æ·»åŠ åˆ° GitHub Secrets ä¸­
#
# ä½¿ç”¨åœºæ™¯ï¼š
#   - åˆæ¬¡è®¾ç½®éƒ¨ç½²ç¯å¢ƒæ—¶çš„ç¬¬ä¸€æ­¥
#   - éœ€è¦é‡æ–°ç”Ÿæˆ SSH å¯†é’¥æ—¶
#   - æ·»åŠ æ–°æœåŠ¡å™¨åˆ°éƒ¨ç½²åˆ—è¡¨æ—¶
#
# å‰ç½®æ¡ä»¶ï¼š
#   - éœ€è¦åœ¨ GitHub Secrets ä¸­é…ç½® XDS_SERVERS_PWDï¼ˆæœåŠ¡å™¨å¯†ç ï¼‰
#   - æœåŠ¡å™¨éœ€è¦æ”¯æŒ SSH è¿æ¥å’Œå¯†ç è®¤è¯
#
# è¾“å‡ºç»“æœï¼š
#   - ç”Ÿæˆæ–°çš„ SSH ç§é’¥ï¼ˆéœ€æ‰‹åŠ¨æ·»åŠ åˆ° GitHub Secretsï¼‰
#   - å…¬é’¥å·²éƒ¨ç½²åˆ°æ‰€æœ‰æŒ‡å®šæœåŠ¡å™¨
#   - SSH è¿æ¥æµ‹è¯•é€šè¿‡
#
# ============================================================================

name: 01-XDeploySSHKey-production

on:
  workflow_dispatch:
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘èƒ½åŠ›

jobs:
  deploy-ssh-key:
    environment: production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set deployment environment
        id: set-env
        run: |
          ENV="${{ vars.XDP_DEPLOY_ENV || 'production' }}"
          echo "DEPLOY_ENV=$ENV" >> "$GITHUB_OUTPUT"
          echo "ä½¿ç”¨éƒ¨ç½²ç¯å¢ƒ: $ENV"

      - name: Generate SSH key pair
        id: generate-key
        run: |
          # è¿è¡Œå¯†é’¥ç”Ÿæˆè„šæœ¬
          bash ./.xdeploy/${{ steps.set-env.outputs.DEPLOY_ENV }}/scripts/workflows/ssh-key-generate.sh

          # å°†å…¬é’¥å†…å®¹å­˜å‚¨åˆ°ç¯å¢ƒå˜é‡
          echo "PUBLIC_KEY=$(cat github-actions-deploy.pub)" >> $GITHUB_ENV

          # å°†ç§é’¥å†…å®¹å­˜å‚¨ä¸ºè¾“å‡ºå˜é‡
          echo "PRIVATE_KEY<<EOF" >> "$GITHUB_OUTPUT"
          cat github-actions-deploy >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Use servers from repository secrets
        id: set-servers
        run: |
          if [ -z "${{ secrets.XDS_SERVERS_PWD }}" ]; then
            echo "::error::ä»“åº“å¯†é’¥ä¸­æœªé…ç½® XDS_SERVERS_PWD"
            exit 1
          fi
          echo "SERVERS=${{ secrets.XDS_SERVERS_PWD }}" >> "$GITHUB_OUTPUT"
          echo "ä½¿ç”¨ä»“åº“å¯†é’¥ä¸­çš„ XDS_SERVERS_PWD (æ ¼å¼ä¸º username@host=password,username@host=password)"

      - name: Extract server info and prepare passwords
        id: prepare-servers
        run: |
          # è¿è¡Œå‡†å¤‡æœåŠ¡å™¨ä¿¡æ¯çš„è„šæœ¬
          CLEAN_SERVERS=$(bash ./.xdeploy/${{ steps.set-env.outputs.DEPLOY_ENV }}/scripts/workflows/ssh-key-prepare-servers.sh "${{ steps.set-servers.outputs.SERVERS }}")
          echo "PROCESSED_SERVERS=$CLEAN_SERVERS" >> "$GITHUB_OUTPUT"

      - name: Deploy public key to servers
        run: |
          # è¿è¡Œéƒ¨ç½²å…¬é’¥è„šæœ¬
          bash ./.xdeploy/${{ steps.set-env.outputs.DEPLOY_ENV }}/scripts/workflows/ssh-key-deploy.sh "${{ steps.prepare-servers.outputs.PROCESSED_SERVERS }}" "${{ env.PUBLIC_KEY }}"

      - name: Test SSH connection with new key
        run: |
          # è¿è¡Œæµ‹è¯•è¿æ¥è„šæœ¬
          bash ./.xdeploy/${{ steps.set-env.outputs.DEPLOY_ENV }}/scripts/workflows/ssh-key-test-connection.sh "${{ steps.prepare-servers.outputs.PROCESSED_SERVERS }}"

      - name: Display new private key
        run: |
          echo "::notice title=æ–° SSH ç§é’¥å·²ç”Ÿæˆ::è¯·å°†æ­¤ç§é’¥æ·»åŠ åˆ° GitHub Secrets ä¸­ï¼Œåç§°ä¸º XDS_SSH_PRIVATE_KEY"
          echo "ç§é’¥å†…å®¹å¦‚ä¸‹ï¼ˆåŒ…æ‹¬å¼€å¤´å’Œç»“å°¾è¡Œï¼‰ï¼š"
          echo "${{ steps.generate-key.outputs.PRIVATE_KEY }}"

          # åˆ›å»ºä¸€ä¸ªæ‘˜è¦
          echo "::group::SSH éƒ¨ç½²æ‘˜è¦"
          echo "âœ… å·²æˆåŠŸéƒ¨ç½²å…¬é’¥åˆ°ä»¥ä¸‹æœåŠ¡å™¨:"
          echo "${{ steps.prepare-servers.outputs.PROCESSED_SERVERS }}"
          echo "ğŸ”‘ å…¬é’¥æŒ‡çº¹:"
          ssh-keygen -lf github-actions-deploy.pub
          echo "::endgroup::"
