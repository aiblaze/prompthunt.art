# ============================================================================
# XDeploy Nginx é…ç½®éƒ¨ç½²å·¥ä½œæµ
# ============================================================================
#
# åŠŸèƒ½è¯´æ˜ï¼š
#   - è‡ªåŠ¨ç”Ÿæˆå’Œéƒ¨ç½² Nginx ç«™ç‚¹é…ç½®æ–‡ä»¶
#   - æ”¯æŒå¤šç§ Nginx é…ç½®æ¨¡æ¿ï¼ˆH5BPã€æ ‡å‡†æ¨¡æ¿ï¼‰
#   - é…ç½® SSL è¯ä¹¦è·¯å¾„å’Œåå‘ä»£ç†è®¾ç½®
#   - éªŒè¯é…ç½®è¯­æ³•å¹¶é‡æ–°åŠ è½½ Nginx
#
# ä½¿ç”¨åœºæ™¯ï¼š
#   - æ–°ç«™ç‚¹é¦–æ¬¡é…ç½® Nginx
#   - æ›´æ–°ç°æœ‰ç«™ç‚¹çš„ Nginx é…ç½®
#   - æ‰¹é‡éƒ¨ç½²é…ç½®åˆ°å¤šå°æœåŠ¡å™¨
#   - ä¿®æ”¹åº”ç”¨ç«¯å£æˆ–åŸŸåé…ç½®
#
# å‰ç½®æ¡ä»¶ï¼š
#   - SSL è¯ä¹¦å·²éƒ¨ç½²ï¼ˆéœ€å…ˆè¿è¡Œ 03-xdeploy-ssl-cert.ymlï¼‰
#   - Nginx å·²å®‰è£…åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Š
#   - SSH å¯†é’¥å·²é…ç½®
#
# æ”¯æŒçš„é…ç½®æ¨¡æ¿ï¼š
#   - H5BPï¼šåŸºäº HTML5 Boilerplate çš„ä¼˜åŒ–é…ç½®
#   - æ ‡å‡†ï¼šé€šç”¨çš„ Nginx é…ç½®æ¨¡æ¿
#
# é…ç½®åŠŸèƒ½ï¼š
#   - SSL/TLS é…ç½®
#   - åå‘ä»£ç†è®¾ç½®
#   - é™æ€èµ„æºä¼˜åŒ–
#   - å®‰å…¨å¤´é…ç½®
#   - Gzip å‹ç¼©é…ç½®
#   - ç¼“å­˜ç­–ç•¥é…ç½®
#
# å®‰å…¨ç‰¹æ€§ï¼š
#   - é…ç½®è¯­æ³•éªŒè¯
#   - å¹³æ»‘é‡æ–°åŠ è½½
#   - é…ç½®å¤‡ä»½æœºåˆ¶
#
# ============================================================================

name: 04-XDeployNginxConfig-production

on:
  workflow_dispatch:

env:
  DEPLOY_CONFIGS_DIR: ${{ github.workspace }}/.xdeploy/production/configs

jobs:
  deploy:
    environment: production
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set deployment environment
        id: set-env
        run: |
          ENV="${{ vars.XDP_DEPLOY_ENV || 'production' }}"
          echo "DEPLOY_ENV=$ENV" >> "$GITHUB_OUTPUT"
          echo "ä½¿ç”¨éƒ¨ç½²ç¯å¢ƒ: $ENV"

      - name: Set parameters
        id: params
        run: |
          # è®¾ç½®æœåŠ¡å™¨
          if [ -n "${{ vars.XDP_SERVERS }}" ]; then
            SERVERS="${{ vars.XDP_SERVERS }}"
          else
            echo "::error::æœªæä¾›æœåŠ¡å™¨ã€‚è¯·åœ¨ production ç¯å¢ƒå˜é‡ä¸­è®¾ç½® XDP_SERVERSã€‚"
            exit 1
          fi
          echo "SERVERS=$SERVERS" >> "$GITHUB_OUTPUT"

          # è®¾ç½®åŸŸå
          if [ -n "${{ vars.XDP_APP_DOMAIN }}" ]; then
            DOMAIN="${{ vars.XDP_APP_DOMAIN }}"
          else
            echo "::error::æœªæä¾›åŸŸåã€‚è¯·åœ¨ production ç¯å¢ƒå˜é‡ä¸­è®¾ç½® XDP_APP_DOMAINã€‚"
            exit 1
          fi
          echo "DOMAIN=$DOMAIN" >> "$GITHUB_OUTPUT"

          # è®¾ç½®åº”ç”¨ç«¯å£
          if [ -n "${{ vars.XDP_APP_PORT }}" ]; then
            APP_PORT="${{ vars.XDP_APP_PORT }}"
          else
            echo "::error::æœªæä¾›åº”ç”¨ç«¯å£ã€‚è¯·åœ¨ production ç¯å¢ƒå˜é‡ä¸­è®¾ç½® XDP_APP_PORTã€‚"
            exit 1
          fi
          echo "APP_PORT=$APP_PORT" >> "$GITHUB_OUTPUT"

          # è®¾ç½®è¯ä¹¦ç›®å½•
          if [ -n "${{ vars.XDP_CERT_DIR }}" ]; then
            CERT_DIR="${{ vars.XDP_CERT_DIR }}"
          else
            echo "::error::æœªæä¾›è¯ä¹¦ç›®å½•ã€‚è¯·åœ¨ production ç¯å¢ƒå˜é‡ä¸­è®¾ç½® XDP_CERT_DIRã€‚"
            exit 1
          fi
          echo "CERT_DIR=$CERT_DIR" >> "$GITHUB_OUTPUT"

          # è®¾ç½® Nginx é…ç½®ç›®å½•
          if [ -n "${{ vars.XDP_NGINX_CONF_DIR }}" ]; then
            NGINX_CONF_DIR="${{ vars.XDP_NGINX_CONF_DIR }}"
          else
            echo "::error::æœªæä¾› Nginx é…ç½®ç›®å½•ã€‚è¯·åœ¨ production ç¯å¢ƒå˜é‡ä¸­è®¾ç½® XDP_NGINX_CONF_DIRã€‚"
            exit 1
          fi
          echo "NGINX_CONF_DIR=$NGINX_CONF_DIR" >> "$GITHUB_OUTPUT"

          # è®¾ç½® Nginx é…ç½®ç±»å‹
          if [ -n "${{ vars.XDP_NGINX_CONF_TYPE }}" ]; then
            NGINX_CONF_TYPE="${{ vars.XDP_NGINX_CONF_TYPE }}"
          else
            NGINX_CONF_TYPE="h5bp"
          fi
          echo "NGINX_CONF_TYPE=$NGINX_CONF_TYPE" >> "$GITHUB_OUTPUT"

      - name: Generate Nginx configuration
        id: nginx_config
        run: |
          mkdir -p ./deploy

          # æ ¹æ® Nginx é…ç½®ç±»å‹é€‰æ‹©æ¨¡æ¿
          if [ "${{ steps.params.outputs.NGINX_CONF_TYPE }}" == "h5bp" ]; then
            echo "ä½¿ç”¨ h5bp é£æ ¼çš„ Nginx é…ç½®æ¨¡æ¿"
            TEMPLATE_FILE="${{ env.DEPLOY_CONFIGS_DIR }}/h5bp-site.nginx.conf"
          else
            echo "ä½¿ç”¨æ ‡å‡† Nginx é…ç½®æ¨¡æ¿"
            TEMPLATE_FILE="${{ env.DEPLOY_CONFIGS_DIR }}/site.nginx.conf"
          fi

          echo "é…ç½®æ¨¡æ¿æ–‡ä»¶ï¼š$TEMPLATE_FILE"

          # ç”Ÿæˆ Nginx é…ç½®æ–‡ä»¶
          cp $TEMPLATE_FILE ./deploy/${{ steps.params.outputs.DOMAIN }}.conf

          echo "ç”Ÿæˆçš„ Nginx é…ç½®æ–‡ä»¶å†…å®¹ï¼š"
          cat ./deploy/${{ steps.params.outputs.DOMAIN }}.conf

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.XDS_SSH_PRIVATE_KEY }}
          known_hosts: unnecessary
          if_key_exists: replace

      - name: Deploy Nginx configuration to servers
        id: deploy
        run: |
          # åˆ†å‰²æœåŠ¡å™¨åˆ—è¡¨
          IFS=',' read -ra SERVER_ARRAY <<< "${{ steps.params.outputs.SERVERS }}"

          # éƒ¨ç½²åˆ°æ¯ä¸ªæœåŠ¡å™¨
          for server in "${SERVER_ARRAY[@]}"; do
            echo "===== å¼€å§‹éƒ¨ç½² Nginx é…ç½®åˆ°æœåŠ¡å™¨: $server ====="

            # æ·»åŠ æœåŠ¡å™¨åˆ°å·²çŸ¥ä¸»æœº
            ssh-keyscan -H $(echo $server | cut -d@ -f2) >> ~/.ssh/known_hosts

            # ä¸Šä¼  Nginx é…ç½®æ–‡ä»¶
            ssh $server "sudo mkdir -p ${{ steps.params.outputs.NGINX_CONF_DIR }}"
            scp ./deploy/${{ steps.params.outputs.DOMAIN }}.conf $server:/tmp/${{ steps.params.outputs.DOMAIN }}.conf
            ssh $server "sudo mv /tmp/${{ steps.params.outputs.DOMAIN }}.conf ${{ steps.params.outputs.NGINX_CONF_DIR }}/${{ steps.params.outputs.DOMAIN }}.conf"

            # æ£€æŸ¥ Nginx é…ç½®è¯­æ³•
            echo "æ£€æŸ¥ Nginx é…ç½®è¯­æ³•..."
            ssh $server "sudo nginx -t" || { echo "Nginx é…ç½®è¯­æ³•æ£€æŸ¥å¤±è´¥"; exit 1; }

            # é‡æ–°åŠ è½½ Nginx é…ç½®
            echo "é‡æ–°åŠ è½½ Nginx é…ç½®..."
            ssh $server "sudo systemctl reload nginx || sudo service nginx reload"

            echo "===== æœåŠ¡å™¨ $server Nginx é…ç½®éƒ¨ç½²å®Œæˆ ====="
          done

      - name: Nginx Config Deployment Summary
        run: |
          echo "âœ… Nginx é…ç½®éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸ“‹ éƒ¨ç½²è¯¦æƒ…ï¼š"
          echo "   - åŸŸåï¼š${{ steps.params.outputs.DOMAIN }}"
          echo "   - éƒ¨ç½²æœåŠ¡å™¨ï¼š${{ steps.params.outputs.SERVERS }}"
          echo "   - è¯ä¹¦ç›®å½•ï¼š${{ steps.params.outputs.CERT_DIR }}"
          echo "   - Nginx é…ç½®ç›®å½•ï¼š${{ steps.params.outputs.NGINX_CONF_DIR }}"
          echo "   - åº”ç”¨ç«¯å£ï¼š${{ steps.params.outputs.APP_PORT }}"
          echo "   - éƒ¨ç½²æ—¶é—´ï¼š$(date)"
